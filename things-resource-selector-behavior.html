<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="./things-resource-dialog.html">

<script>

window.Things = window.Things || {};

/**
 * ResourceSelector를 오픈해주는 Behavior. ResourceSelector는 Form이나 Grid에서 오픈할 수 있다.
 * 주의 : things-selector-content.html 파일을 import 하면 안 된다. 그럴 경우 circular reference 때문인지 behavior가 작동하지 않는다.
 *
 * @polymerBehavior Things.ResourceSelectorBehavior
 * 
 * @demo demo/index.html
 */
Things.ResourceSelectorBehavior = {

  /**
   * open resource selector - 그리드에서 사용 
   *
   * @params {Object} parentGrid
   * @params {Object} parentGridRowIdx
   * @params {Object} resourceObj
   * @param {Boolean} modal modal로 오픈할 지 여부
   */
  openResourceSelectorByGrid: function(parentGrid, parentGridRowIdx, resourceObj, modal) {
    var selector = this._createResourceContent(resourceObj.resourceType);
    this._getResourceSelectorDialog().showResourceDialog(selector, modal, selector.refreshGridData);
    this._addSelectedListenerByGrid(selector, parentGrid, parentGridRowIdx, resourceObj);
  },

  /**
   * resource-content element를 생성한다.
   *
   * @param {String} resourceName
   * @return {Object} element
   */
  _createResourceContent: function(resourceName) {
    var selector = document.createElement('things-selector-content');
    selector.id = "resource-selector";
    selector.menuName = resourceName;
    return selector;
  },

  /**
   * selector selected changed 
   *
   * @params {Object} parentGrid
   * @params {Object} parentGridRowIdx
   * @params {Object} resourceObj
   * @param {Object} selector
   */
  _addSelectedListenerByGrid: function(selector, parentGrid, parentRowIdx, resourceObj) {
    var me = this;

    selector.addEventListener('things-grid-row-data-select', function(e) {
      // 메뉴에서 설정한 idField와 titleField로 e.detail내의 값을 추출한 뒤 object로 구성하여 그리드의 row 데이터 중에 업데이트 할 필드로 업데이트한다.
      var idField = e.currentTarget.getIdField();
      var titleField = e.currentTarget.getTitleField();
      var row = parentGrid.focusedRow();
      var dataSet = parentGrid.dataSource();
      var valueField = resourceObj.valueField;

      if(row && row.dataIndex() >= 0) {
        var rowObj = row.getRowObject();
        var selectedObj = rowObj[valueField];
        selectedObj[idField] = e.detail[idField];
        selectedObj[titleField] = e.detail[titleField];
        rowObj[valueField] = selectedObj;
        me.fire('things-resource-selector-selected', { rowObj: rowObj, resource : e.detail } );
        dataSet.updateRow(parentRowIdx, rowObj);
        // popup 닫기 
        me._getResourceSelectorDialog().closeResourceDialog();
        // 부모 그리드 Refresh
        parentGrid.refreshView();
      }
    });
  },

  /**
   * open resource selector - form에서 사용 
   *
   * @params {Object} container
   * @param {Boolean} modal modal로 오픈할 지 여부
   */
  openResourceSelectorByForm: function(container, modal) {
    var selector = this._createResourceContent(container.resourceType);
    this._getResourceSelectorDialog().showResourceDialog(selector, modal, selector.refreshGridData);
    this._addSelectedListenerByForm(selector, container);
  },

    /**
   * selector selected changed 
   *
   * @params {Object} parentGrid
   * @params {Object} parentGridRowIdx
   * @params {Object} resourceObj
   * @param {Object} selector
   */
  _addSelectedListenerByForm: function(selector, container) {
    var me = this;

    selector.addEventListener('things-grid-row-data-select', function(e) {
      // popup 닫기 
      me._getResourceSelectorDialog().closeResourceDialog();
      // 값 설정 
      container.setObjValue(e.detail);
    });
  },

  /**
   * Resource Selector Dialog
   */
  _getResourceSelectorDialog: function() {
    // FIXME things-full-dialog 처럼 이벤트 방식으로 변경한다.
    return app.$['resource-dialog'];
  }

};

</script>
