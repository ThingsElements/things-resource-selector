<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="./things-resource-selector-behavior.html">
<link rel="import" href="../things-combo/things-combo.html">

<!--
Resource field. 서버에 저장되어 있는 리소스 정보를 조회하여 input field에 표시하는 컴포넌트 

  Example:

    <things-resource-field 
      id="resource-selector" 
      label="Language" 
      name="user_id"
      resource-type="User" 
      resource-url="users"
      delegate-column="name">
    </things-resource-field>


@demo demo/demo-resource-field.html
-->

<dom-module id="things-resource-field">
  <style>
    label{
      @apply(--things-label);
    }
    input{
      @apply(--things-input);
      width:calc(65% - 37px);
    }
    paper-icon-button{
      @apply(--things-small-icon);
      margin-right:7px;margin-left:-27px;
      opacity:.4;
      position:relative;
      top:-2px;
    }
    iron-icon{
      @apply(--things-picker-button);
      background:url(/images/icon-resource-select.png) 50% 3px no-repeat var(--paper-blue-grey-300);
    }
  </style>

  <template>
    <input id="id-value-field" is="iron-input" name="[[submitName]]" bind-value="[[idValue]]" hidden>

    <label>[[label]]</label>
    <input is="iron-input" value="[[displayValue]]" readonly>
    <paper-icon-button suffix on-tap="clearValue" icon="clear" alt="clear" title="clear" hidden="[[readOnly]]">
    </paper-icon-button>
    <iron-icon prefix on-tap="openResourceSelector" hidden="[[readOnly]]"></iron-icon>
  </template>

  <script type="text/javascript">
    Polymer({
      is: "things-resource-field",

      properties: {

        /**
         * Form Load시에 서버에서 받은 데이터와 things-resource-field값과 매핑하기 위한 필드명.
         * 예를 들어 특정 resource에 creator_id가 있다면 서버에서 해당 resource를 조회하면 creator 데이터에 { id : '10', name : '홍길동' } 형식으로 넘어온다. 
         * Form에서 things-resource-field가 creator와 매핑되어 있다면 name 필드는 creator가 되고 submitName은 creator_id가 된다.
         * Form 로딩 후에 사용자가 편집을 다시하여 서버에 보낼 경우 submitName으로 id값만 보내게 된다.
         */
        name : {
          type: String
        },

        /**
         * Form Submit시에 서버로 날려줄 Form Field Name
         */
        submitName: {
          type: String
        },

        /**
         * Input field 상단에 표시할 라벨 
         */
        label: {
          type: String
        },

        /**
         * Resource Selector로 부터 선택한 값 
         */
        value: {
          type: Object,
          observer: '_valueChanged'
        },

        /**
         * Resource Selector로 부터 선택한 Object 값의 id
         */
        idValue: {
          type: String
        },

        /**
         * Resource Selector로 부터 선택한 표시 값 
         */
        displayValue: {
          type: String
        },

        /**
        * Resource Type - Entity or Menu
        * 1) Entity : Entity 설정에 의한 Selector 화면 구성 
        * 2) Menu : Menu 설정에 의한 Selector 화면 구성
        */
        resourceType: {
          type: String,
          value: 'Entity'
        },
      
        /**
         * Resource Selector에서 표시할 리소스 명
         * resourceType이 Menu로 선택되어 있다면 Menu 명, resourceType이 Entity로 선택되어 있다면 Entity 명이 된다.
         */
        resourceName: {
          type: String
        },

        /**
         * Resource Selector를 띄우기 위해 필요한 기본 파라미터 
         * Format : {Parameter Name1}:{Parameter Value1},{Parameter Name2}:{Parameter Value2},... 
         */
        initialParams: {
          type: String
        },

        /**
         * Initial Params가 변경되기 때문에 항상 설정한 값으로 보관 
         */
        oriInitialParams: {
          type: String
        },

        /**
         * Resource Selector에서 선택한 resource의 id field
         * Resource Selector에서 선택한 resource의 id값이 이 필드가 가지는 실제 값이 된다. 
         */
        resourceIdField: {
          type: String,
          value: 'id'
        },

        /**
         * Resource Selector에서 선택한 resource의 title field
         * 화면에 표시할 대표 컬럼명. 
         */
        resourceTitleField: {
          type: String,
          value: 'name'
        },

        /**
         * 읽기 전용인지 여부 
         */
        readOnly: {
          type: Boolean,
          value: false
        }
      },

      behaviors: [
        Things.ResourceSelectorBehavior
      ],

      /**
       * value값이 변경될 경우 
       *
       * @param {Object} value
       */
      _valueChanged: function(value) {
        if(this.value) {
          this.idValue = this.value[this.resourceIdField];
          this.displayValue = this.value[this.resourceTitleField];
        } else {
          this.idValue = null;
          this.displayValue = '';
        }
      },

      /**
       * Resource Selector로 부터 id, display 값을 설정한다.
       *
       * @param {String} idValue
       * @param {String} displayValue
       */
      setResourceValue: function(idValue, displayValue) {
        this.idValue = idValue;
        this.displayValue = displayValue;
      },

      /**
       * 설정된 값을 리턴
       */
      getValue: function() {
        return this.value;
      },

      /**
       * Resource Selector로 부터 값을 설정
       *
       * @param {Object} value
       */
      setValue: function(value) {
        this.value = value;
      },

      /**
       * Open Resource Selector
       */
      openResourceSelector: function() {
        this.preprocessInitialParams();
        this.openResourceSelectorByForm(this, true);
      },

      /**
       * initialParams가 설정되어 있고, 변수를 의미하는 $가 존재하고 
       * container가 폼이라면 폼에서 initialParams의 변수명에 해당하는 이름으로 데이터를 찾아 initialParams를 구성하고 
       * container가 그리드라면 그리드의 해당 row에서 initialParams의 변수명에 해당하는 이름으로 데이터를 찾아 initialParams를 구성한다.
       */
      preprocessInitialParams: function() {
        if(!this.oriInitialParams && this.initialParams && this.initialParams.indexOf('$') > 1) {
          this.oriInitialParams = this.initialParams;
        }

        if(this.oriInitialParams) {
          var form = this.findOwnerForm(this);
          if(form && form.serialize) {
            var formData = form.serialize ? form.serialize() : (form.serializeMyForm ? form.serializeMyForm() : null);
            if(formData) {
              this.changeInitialParams(formData);
            }
          }
        }
      },

      /**
       * initialParams에서 변수(즉 $부분)를 찾아 formData의 값으로 Replace
       *
       * @param {Object} formData
       */
      changeInitialParams: function(formData) {
        var initParamArr = this.oriInitialParams.split(',');
        for(var i = 0 ; i < initParamArr.length ; i++) {
          var initParam = initParamArr[i];
          var paramArr = initParam.split('=');
          var varName = paramArr[1];

          if(varName[0] == '$') {
            var varData = formData[varName.substr(1)] || '';
            this.initialParams = this.oriInitialParams.replace(varName, varData);
          }
        }
      },

      /**
       * Resource Selector의 Container 폼을 찾아 리턴
       */
      findOwnerForm: function(element) {
        if(!element.parentElement) {
          return null;
        } else {
          if(element.parentElement.localName == 'form' || 
             element.parentElement.localName == 'things-form' || 
             element.parentElement.localName == 'things-search-form') {
            return element.parentElement;
          } else {
            return this.findOwnerForm(element.parentElement);
          }
        }
      },

      /**
       * 값을 리셋
       */
      clearValue: function() {
        var obj = {};
        obj[this.resourceIdField] = '0';
        obj[this.resourceTitleField] = null;
        this.value = obj;
      }

    });
  </script>
</dom-module>
