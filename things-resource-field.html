<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<link rel="import" href="./things-resource-selector-behavior.html">
<link rel="import" href="../things-combo/things-combo.html">

<!--
Resource field. 서버에 저장되어 있는 리소스 정보를 조회하여 input field에 표시하는 컴포넌트 

  Example:

    <things-resource-field 
      id="resource-selector" 
      label="Language" 
      name="user_id"
      resource-type="User" 
      resource-url="users"
      delegate-column="name">
    </things-resource-field>


@demo demo/demo-resource-field.html
-->

<dom-module id="things-resource-field">
  <style>
    label{
      @apply(--things-label);
    }
    input{
      @apply(--things-input);
      width:calc(65% - 37px);
    }
    paper-icon-button{
      @apply(--things-small-icon);
      margin-right:7px;margin-left:-27px;
      opacity:.4;
      position:relative;
      top:-2px;
    }
    iron-icon{
      @apply(--things-picker-button);
      background:url(/images/icon-resource-select.png) 50% 3px no-repeat var(--paper-blue-grey-300);
    }
  </style>

  <template>
    <input id="id-value-field" is="iron-input" name="[[submitName]]" bind-value="[[idValue]]" hidden>

    <label>[[label]]</label>
    <input is="iron-input" value="[[displayValue]]" readonly>
    <paper-icon-button suffix on-tap="clearValue" icon="clear" alt="clear" title="clear" hidden="[[readOnly]]">
    </paper-icon-button>
    <iron-icon prefix on-tap="openResourceSelector" hidden="[[readOnly]]"></iron-icon>
  </template>

  <script type="text/javascript">
    (function() {
      Polymer({
        is: "things-resource-field",

        properties: {

          /**
           * Form Load시에 서버에서 받은 데이터와 things-resource-field값과 매핑하기 위한 필드명.
           * 예를 들어 특정 resource에 creator_id가 있다면 서버에서 해당 resource를 조회하면 creator 데이터에 { id : '10', name : '홍길동' } 형식으로 넘어온다. 
           * Form에서 things-resource-field가 creator와 매핑되어 있다면 name 필드는 creator가 되고 submitName은 creator_id가 된다.
           * Form 로딩 후에 사용자가 편집을 다시하여 서버에 보낼 경우 submitName으로 id값만 보내게 된다.
           */
          name : {
            type: String
          },

          /**
           * Form Submit시에 서버로 날려줄 Form Field Name
           */
          submitName: {
            type: String
          },

          /**
           * input field 상단에 표시할 라벨 
           */
          label: {
            type: String
          },

          /**
           * Resource Selector로 부터 선택한 값 
           */
          value: {
            type: Object,
            observer: '_valueChanged'
          },

          /**
           * Resource Selector로 부터 선택한 Object 값의 id
           */
          idValue: {
            type: String
          },

          /**
           * Resource Selector로 부터 선택한 표시 값 
           */
          displayValue: {
            type: String
          },

          /**
          * Resource Selector Type - Entity or Menu
          * 1) Entity : Entity 설정에 의한 Selector 화면 구성 
          * 2) Menu : Menu 설정에 의한 Selector 화면 구성
          */
          selectorType: {
            type: String,
            value: 'Entity'
          },
        
          /**
           * entity type
           */
          resourceType: {
            type: String
          },

          /**
           * 데이터 조회를 위한 URL
           */
          resourceUrl: {
            type: String
          },

          /**
           * 화면에 표시할 대표 컬럼명 
           */
          delegateColumn: {
            type: String,
            value: 'name'
          },

          /**
           * 읽기 전용인지 여부 
           */
          readOnly: {
            type: Boolean,
            value: false
          }
        },

        behaviors: [
          Things.ResourceSelectorBehavior
        ],

        /**
         * value값이 변경될 경우 
         *
         * @param {Object} value
         */
        _valueChanged: function(value) {
          if(this.value) {
            this.idValue = this.value.id;
            this.displayValue = this.value[this.delegateColumn];            
          } else {
            this.idValue = null;
            this.displayValue = '';
          }
        },

        /**
         * Resource Selector로 부터 Object 값을 설정
         *
         * @param {Object} objValue
         */
        setObjValue: function(objValue) {
          this.value = objValue;
        },

        /**
         * 설정된 값을 리턴
         */
        getValue: function() {
          return this.value;
        },

        /**
         * Resource Selector로 부터 값을 설정
         *
         * @param {Object} value
         */
        setValue: function(value) {
          this.value = value;
        },

        /**
         * Open Resource Selector
         */
        openResourceSelector: function() {
          this.openResourceSelectorByForm(this, true);
        },

        /**
         * 값을 리셋
         */
        clearValue: function() {
          var obj = { id : '0' };
          obj[this.delegateColumn] = '';
          this.value = obj;
        }

      })
    })();
  </script>
</dom-module>
